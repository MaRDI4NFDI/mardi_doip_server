name: Build DOIP CLI - MultiOS

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-22.04]
        python-version: ["3.12"]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      ###################################################################
      # INSTALL DEPENDENCIES
      ###################################################################

      - name: Install deps (macOS/Linux-native)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Install deps (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          python -m venv venv
          call venv\Scripts\activate
          pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install -r requirements.txt

      ###################################################################
      # RUN TESTS
      ###################################################################

      - name: Run tests (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          source venv/bin/activate
          pytest -vv

      - name: Run tests (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          call venv\Scripts\activate
          pytest -vv

      ###################################################################
      # BUILD BINARIES
      ###################################################################

      # Windows executable
      - name: Build CLI (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          call venv\Scripts\activate
          pyinstaller --onefile client_cli\main.py ^
            --name mardi-doip-cli ^
            --console ^
            --clean ^
            --log-level=WARN ^
            --hidden-import=anyio ^
            --hidden-import=sniffio ^
            --hidden-import=h11
          certutil -hashfile dist\mardi-doip-cli.exe SHA256 > dist\checksum.txt

      # macOS executable
      - name: Build CLI (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          source venv/bin/activate
          pyinstaller --onefile client_cli/main.py \
            --name mardi-doip-cli \
            --console \
            --clean \
            --log-level=WARN \
            --hidden-import=anyio \
            --hidden-import=sniffio \
            --hidden-import=h11
          shasum -a 256 dist/mardi-doip-cli > dist/checksum.txt

      # ManyLinux executable (best compatibility)
      - name: Build CLI (ManyLinux2014)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            -w /src \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -c "
              /opt/python/cp312-cp312/bin/python -m venv venv &&
              source venv/bin/activate &&
              pip install --upgrade pip wheel setuptools &&
              pip install pyinstaller &&
              pip install -r requirements.txt &&
              pyinstaller --onefile client_cli/main.py \
                --name mardi-doip-cli \
                --console \
                --clean \
                --log-level=WARN \
                --hidden-import=anyio \
                --hidden-import=sniffio \
                --hidden-import=h11
            "
          sha256sum dist/mardi-doip-cli > dist/checksum.txt

      ###################################################################
      # UPLOAD
      ###################################################################

      - name: Upload CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mardi-doip-cli-${{ matrix.os }}-latest
          path: |
            dist/mardi-doip-cli*
            dist/checksum.txt
          if-no-files-found: error
